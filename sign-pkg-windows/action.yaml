name: sign-pkg-windows
description:
  Sign and package the Windows Linden viewer.

##inputs:
##  channel:
##    description: "Viewer channel"
##    type: string
##    required: true
##  version:
##    description: "Viewer version"
##    type: string
##    required: true

runs:
  using: composite
  steps:
    - name: Fetch Windows app
      uses: actions/download-artifact@v3
      with:
        name: Windows-app
        path: .app

    - name: Sign the viewer
      uses: ${{ github.action_path }}/sign
      with:
        executable: .app/SecondLifeViewer.exe

    - name: Sign the updater
      uses: ${{ github.action_path }}/sign
      with:
        executable: .app/SLVersionChecker.exe

    - name: Sign dullahan_host
      uses: ${{ github.action_path }}/sign
      with:
        executable: .app/llplugin/dullahan_host.exe

    - name: Build the installer
      id: nsis
      shell: python
      run: |
        # Logic derived from viewer_manifest.py - still needed though?
        # Use Python because bash refuses to expand "${programfiles(x86)}" --
        # even though that's really the name of the Windows environment
        # variable.
        import os
        import shlex
        import subprocess
        nsis_path = "makensis.exe"
        try:
            for program_files in os.getenv('programfiles'), os.getenv('programfiles(x86)'):
                if program_files:
                    for subpath in 'NSIS', r'NSIS\Unicode':
                        possible_path = os.path.join(program_files, subpath, nsis_path)
                        if os.path.isfile(possible_path):
                            nsis_path = possible_path
                            # don't just break: we need to exit multiple
                            # levels of 'for' loop
                            raise StopIteration()
        except StopIteration:
            pass

        # This .nsi file was prepared by viewer_manifest.py (by substituting
        # values into a template .nsi file) and bundled into the top level of
        # the Windows-app artifact.
        command = [nsis_path, '/V2', 'secondlife_setup_tmp.nsi']
        print(shlex.join(command))
        subprocess.check_call(command, cwd='.app')

    - name: Dump NSIS input file
      if: ${{ failure() && steps.nsis.conclusion == 'failure' }}
      shell: bash
      run: cat '.app/secondlife_setup_tmp.nsi'

    - name: Find the installer
      shell: bash
      run: |
        installer="$(ls -t .app/*_Setup.exe | head -n 1)"
        # pass installer to next step
        echo "installer=$installer" >> "$GITHUB_ENV"

    - name: Sign the installer
      uses: ${{ github.action_path }}/sign
      with:
        executable: ${{ env.installer }}

    - name: Post the installer
      uses: actions/upload-artifact@v3
      with:
        name: "Windows-installer"
        path: ${{ env.installer }}
